import { Controller } from '@hotwired/stimulus'
import ejs from 'ejs'
import I18n from 'i18n-js'

import dbConnection from '../db_connection'
import rowPartial from '_meals_row.html.erb'

I18n.locale = 'nl'
I18n.translations = <%= I18n::JS.filtered_translations.to_json %>
const { t } = I18n

const button_to = label => `<input type="submit" value="${label}">`

export default class extends Controller {
  static targets = ['tableBody']

  async connect() {
    const transaction = (await dbConnection).transaction('meals', 'readonly')
    const meals = transaction.objectStore('meals')
    const request = meals.count()
    request.onsuccess = () => console.log('meals', request.result)

    const result = await fetch('<%= Rails.application.routes.path_for(controller: :meals, action: :index) %>.json')
    const rows = (await result.json()).reverse()
    // TODO: remove the network response warning
    console.log('fetch', result.status, rows)
    rows.forEach(meal => {
      const temp = document.createElement('template')
      temp.innerHTML = ejs.render(rowPartial, { meal, t, button_to }, { escape: s => s }).trim()
      this.tableBodyTarget.prepend(temp.content.firstChild)
    })
  }
}
